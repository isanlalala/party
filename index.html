<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Party Pro: Teams & Seats</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #6366f1; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #1e293b; }
        .section { margin-bottom: 30px; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px; }
        .btn-group { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin: 10px 0; }
        button { padding: 10px 16px; border: none; border-radius: 6px; background: var(--primary); color: white; cursor: pointer; transition: 0.2s; font-weight: 600; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button.secondary { background: #64748b; }
        button.win-btn { background: #22c55e; width: 100%; margin-top: 10px; }
        input { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; width: 80px; text-align: center; }
        .display-box { background: #f1f5f9; padding: 15px; border-radius: 8px; margin-top: 10px; font-family: monospace; min-height: 50px; }
        .dashboard-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .dashboard-table th, .dashboard-table td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; }
        .hidden { display: none; }
		
		/* Word Display Container */
		#word-display {
			transition: background-color 0.2s ease;
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			text-align: center;
		}

		/* Typography for Big TV */
		.display-word { font-size: 3.5rem; font-weight: 800; margin: 0; }
		.display-translation { font-size: 1.5rem; opacity: 0.8; margin-top: 5px; }
		.display-category { font-size: 0.9rem; text-transform: uppercase; margin-top: 20px; opacity: 0.6; font-weight: bold; }

		/* The Success Flash */
		.flash-green {
			background-color: #22c55e !important;
		}
		
    </style>
</head>
<body>

<div class="container">
    <div class="btn-group" style="margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
        <button class="secondary" onclick="showView('setup')">üè† Assignment</button>
        <button style="background: #db2777; color: white;" onclick="showView('bigtv')">üì∫ Â§ßÈõªË¶ñ</button>
        <button class="secondary" onclick="toggleDashboard()">üìä Stats</button>
    </div>

    <div id="view-setup" class="view">
        <div class="section">
            <h2>ü™ë Quick Seat Draw</h2>
            <div class="btn-group">
                <button class="secondary" onclick="initSeatDraw(2)">2</button>
                <button class="secondary" onclick="initSeatDraw(3)">3</button>
                <button class="secondary" onclick="initSeatDraw(4)">4</button>
                <button class="secondary" onclick="initSeatDraw(5)">5</button>
                <button class="secondary" onclick="initSeatDraw(6)">6</button>
                <button class="secondary" onclick="initSeatDraw(7)">7</button>
                <button class="secondary" onclick="initSeatDraw(8)">8</button>
                <button class="secondary" onclick="initSeatDraw(9)">9</button>
                <button class="secondary" onclick="initSeatDraw(10)">10</button>
            </div>
            
            <div id="seatActionArea" class="hidden" style="text-align: center; margin-top: 15px;">
                <button onclick="drawNextSeat()" id="drawBtn">What's my seat?</button>
                <div class="display-box" id="seatDisplay">Select players above</div>
            </div>
        </div>

        <div class="section">
            <h2>‚öîÔ∏è Team Assignment</h2>
            <div id="setupForm">
                <label>
                    <input type="checkbox" id="useDefault" checked onchange="togglePlayerInputs()"> ÁµÑÁπî Players
                </label>

                <div id="customPlayerSetup" class="hidden" style="margin-top: 15px; background: #f1f5f9; padding: 15px; border-radius: 8px;">
                    <label>How many players? </label>
                    <input type="number" id="playerCount" value="5" min="2" max="20" onchange="generateNameInputs()" style="width: 50px;">
                    <div id="nameInputsArea" style="margin-top: 10px;"></div>
                </div>

                <div class="btn-group" style="margin-top: 15px;">
                    <button onclick="assignTeams()" style="width: 100%;">Assign Teams & Seats</button>
                </div>
            </div>

            <div id="teamResult" class="display-box hidden"></div>
            
            <div id="winButtons" class="hidden" style="margin-top: 10px;">
                <button class="win-btn" onclick="recordWin(1)">Team 1 Won!</button>
                <button class="win-btn" onclick="recordWin(2)">Team 2 Won!</button>
            </div>
        </div>
    </div>

    <div id="view-bigtv" class="view hidden">
        <div class="section" style="text-align: center;">
            <h2 style="color: #db2777;">üì∫ Â§ßÈõªË¶ñ</h2>
            
            <div id="game-lobby">
                <div style="background: #fff1f2; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #fda4af; text-align: left;">
                    
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">üìÅ Select Categories:</label>
                    <div id="category-checklist" style="max-height: 150px; overflow-y: auto; background: white; border: 1px solid #db2777; border-radius: 5px; padding: 10px; margin-bottom: 15px;">
					<label style="display: block; font-weight: bold; cursor: pointer;">
						<input type="checkbox" id="check-all" onchange="toggleAllCats(this.checked)" checked> (Select / Deselect All)
					</label>
					<hr style="margin: 8px 0; border: 0; border-top: 1px solid #eee;">
					<div id="category-items">
						</div>
					</div>

                    <div>
                        <label style="display: block; font-weight: bold; margin-bottom: 5px;">‚è±Ô∏è Play Time:</label>
                        <div class="btn-group">
                            <button class="secondary time-opt" onclick="setTime(10)" id="t10">10s</button>
                            <button class="secondary time-opt" onclick="setTime(90)" id="t90">90s</button>
                            <button class="secondary time-opt" onclick="setTime(120)" id="t120">120s</button>
							<button class="secondary time-opt" onclick="setTime(300)" id="t300">300s</button>
							<button class="secondary time-opt" onclick="setTime(600)" id="t600">600s</button>
                        </div>
                    </div>
                </div>
                <button onclick="startBigTV()" style="font-size: 1.2em; padding: 15px 30px; background: #db2777; width: 100%;">START GAME</button>
            </div>

            <div id="game-active" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="font-size: 1.1em;">Time: <span id="timer" style="color:red; font-weight:bold;">60</span>s | Score: <span id="score" style="font-weight:bold;">0</span></div>
                    <button onclick="endGame(true)" style="background: #ef4444; padding: 5px 10px; font-size: 0.8em;">Stop Game</button>
                </div>
                <div id="word-display">LOADING...</div>
                <div class="btn-group">
                    <button onclick="nextWord(false)" style="background:#64748b; flex:1;">SKIP</button>
                    <button onclick="nextWord(true)" style="background:#22c55e; flex:2;">CORRECT ‚úÖ</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="dashboard" class="hidden section">
        <h2 style="text-align: center;">üìä Party Stats & History</h2>
        <div id="historyLog"></div>
    </div>
</div>

<script>
    // --- 0. FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyASFJBuecdsEkY4c_40_qtaMQRvcS69VNI",
        authDomain: "party-8c722.firebaseapp.com",
        projectId: "party-8c722",
        storageBucket: "party-8c722.firebasestorage.app",
        messagingSenderId: "848163286246",
        appId: "1:848163286246:web:d7f811ee2664dacfcf9f27",
        measurementId: "G-V7WJLYJT70"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
	
	// --- NAVIGATION LOGIC ---
    window.showView = function(viewName) {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        document.getElementById('view-' + viewName).classList.remove('hidden');
        document.getElementById('dashboard').classList.add('hidden'); // Hide stats when switching
    };

    // --- 1. GLOBAL STATE ---
    let availableSeats = [];
    let totalSeatsSet = 0;
    let confirmedCount = 0;
    const defaultPlayers = ["I Sanüç≠", "Rickyüêπ", "Angela", "Lawrence", "Suzanne"];
    let currentTeams = { team1: [], team2: [] };

    // --- 2. SEAT DRAW LOGIC ---
    window.initSeatDraw = function(num) {
        if(!num || num < 1) return;
        totalSeatsSet = parseInt(num);
        confirmedCount = 0;
        availableSeats = Array.from({length: totalSeatsSet}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
        
        document.getElementById('seatActionArea').classList.remove('hidden');
        document.getElementById('seatDisplay').innerText = `Ready to draw for ${num} players.`;
        document.getElementById('drawBtn').disabled = false;
    };

    window.drawNextSeat = function() {
        if(availableSeats.length > 0) {
            const seat = availableSeats.pop();
            confirmedCount++;
            document.getElementById('seatDisplay').innerHTML = `<strong>Your Seat: (${seat})</strong> <br> Confirmed: (${confirmedCount}/${totalSeatsSet})`;
            if(availableSeats.length === 0) {
                document.getElementById('drawBtn').disabled = true;
            }
        }
    };

    // --- 3. TEAM ASSIGNMENT LOGIC ---
    window.togglePlayerInputs = function() {
        const isDefault = document.getElementById('useDefault').checked;
        const customArea = document.getElementById('customPlayerSetup');
        if (customArea) {
            customArea.classList.toggle('hidden', isDefault);
            if (!isDefault) generateNameInputs();
        }
    };

    window.generateNameInputs = function() {
        const count = parseInt(document.getElementById('playerCount').value) || 5;
        const area = document.getElementById('nameInputsArea');
        area.innerHTML = "";
        const defaultNames = ["I San", "Ricky", "Angela", "Lawrence", "Suzanne"];
        
        area.style.display = "grid";
        area.style.gridTemplateColumns = "repeat(auto-fit, minmax(140px, 1fr))";
        area.style.gap = "10px";
        area.style.width = "100%";
        area.style.boxSizing = "border-box";

        for (let i = 1; i <= count; i++) {
            const defaultValue = defaultNames[i - 1] || "";
            area.innerHTML += `
                <div style="display: flex; flex-direction: column;">
                    <label style="font-size: 0.75rem; color: #64748b; margin-bottom: 4px;">Player ${i}</label>
                    <input type="text" class="player-name-input" value="${defaultValue}" placeholder="Name..." 
                           style="padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; width: 100%; box-sizing: border-box;">
                </div>`;
        }
    };

    window.assignTeams = function() {
        let players = [];
        const isDefault = document.getElementById('useDefault').checked;
        if (isDefault) {
            players = [...defaultPlayers];
        } else {
            const inputs = document.querySelectorAll('.player-name-input');
            inputs.forEach(input => {
                if (input.value.trim() !== "") players.push(input.value.trim());
            });
            if (players.length < 2) {
                alert("Please enter at least 2 player names!");
                return;
            }
        }
        players.sort(() => Math.random() - 0.5);
        const seats = Array.from({length: players.length}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
        const mid = Math.ceil(players.length / 2);
        currentTeams.team1 = players.slice(0, mid).map(p => ({name: p, seat: seats.pop()}));
        currentTeams.team2 = players.slice(mid).map(p => ({name: p, seat: seats.pop()}));

        let html = "<strong>Team 1:</strong> " + currentTeams.team1.map(p => `${p.name}(${p.seat})`).join(", ") + "<br>";
        html += "<strong>Team 2:</strong> " + currentTeams.team2.map(p => `${p.name}(${p.seat})`).join(", ");
        document.getElementById('teamResult').innerHTML = html;
        document.getElementById('teamResult').classList.remove('hidden');
        document.getElementById('winButtons').classList.remove('hidden');
    };

    // --- 4. WIN RECORDING ---
    function getTodayString() {
        const d = new Date();
        return `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`;
    }

    window.recordWin = async function(winningTeamNum) {
        try {
            const dateKey = getTodayString();
            const winners = winningTeamNum === 1 ? currentTeams.team1 : currentTeams.team2;
            const allPlayers = [...currentTeams.team1, ...currentTeams.team2];
            const dayRef = db.collection("daily_stats").doc(dateKey);
            const doc = await dayRef.get();
            let dayData = doc.exists ? doc.data() : {};

            allPlayers.forEach(p => {
                const pName = p.name.toLowerCase();
                const isWinner = winners.some(w => w.name === p.name);
                if (!dayData[pName]) dayData[pName] = { wins: 0, total: 0 };
                dayData[pName].total += 1;
                if (isWinner) dayData[pName].wins += 1;
            });

            await dayRef.set(dayData);
            alert(`Match recorded for ${dateKey}!`);
            window.toggleDashboard(true);
        } catch (e) {
            console.error("Save error:", e);
        }
    };

    // --- 5. DASHBOARD LOGIC ---
    window.toggleDashboard = async function(forceShow = false) {
        const dash = document.getElementById('dashboard');
        const logArea = document.getElementById('historyLog');
        if (forceShow) dash.classList.remove('hidden');
        else dash.classList.toggle('hidden');

        if (!dash.classList.contains('hidden')) {
            logArea.innerHTML = "‚åõ Calculating MVPs...";
            try {
                const snapshot = await db.collection("daily_stats").get();
                if (snapshot.empty) {
                    logArea.innerHTML = "<p style='text-align:center;'>No games found.</p>";
                    return;
                }
                let fullHtml = "";
                const docs = [];
                snapshot.forEach(doc => docs.push({ id: doc.id, data: doc.data() }));
                docs.sort((a, b) => b.id.localeCompare(a.id));

                docs.forEach(item => {
                    const dateKey = item.id;
                    const playersMap = item.data;
                    let maxRate = -1;
                    for (const name in playersMap) {
                        const stats = playersMap[name];
                        const rate = stats.total > 0 ? (stats.wins / stats.total) : 0;
                        if (rate > maxRate) maxRate = rate;
                    }
                    let tableRows = "";
                    for (const playerName in playersMap) {
                        const stats = playersMap[playerName];
                        const w = stats.wins || 0;
                        const t = stats.total || 0;
                        const currentRate = t > 0 ? (w / t) : 0;
                        const displayRate = Math.round(currentRate * 100);
                        const isMVP = (currentRate === maxRate && w > 0);
                        const crown = isMVP ? " üëë" : "";
                        let color = displayRate >= 60 ? "#22c55e" : (displayRate <= 40 && t > 0 ? "#ef4444" : "#64748b");
                        tableRows += `<tr style="${isMVP ? 'background: rgba(255, 215, 0, 0.05);' : ''}">
                            <td style="padding:12px; border-bottom:1px solid #eee;"><strong>${playerName.toUpperCase()}${crown}</strong></td>
                            <td style="padding:12px; border-bottom:1px solid #eee; color:${color}; font-weight:800;">${displayRate}%</td>
                            <td style="padding:12px; border-bottom:1px solid #eee;">${w}W - ${t-w}L <small>(${t})</small></td>
                        </tr>`;
                    }
                    fullHtml += `<div style="margin-bottom:20px; border:1px solid #e2e8f0; border-radius:12px; background:white; overflow:hidden;">
                        <div style="background:#4f46e5; color:white; padding:10px 15px; font-weight:bold;">üìÖ ${dateKey}</div>
                        <table style="width:100%; border-collapse:collapse; text-align:left;">
                            <thead style="background:#f8fafc;"><tr><th style="padding:10px;">Player</th><th style="padding:10px;">Rate</th><th style="padding:10px;">W/L</th></tr></thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    </div>`;
                });
                logArea.innerHTML = fullHtml;
            } catch (e) {
                logArea.innerHTML = "‚ùå Error loading stats.";
            }
        }
    };

	 // --- 6. BIG TV (Â§ßÈõªË¶ñ) ENGINE ---
	let gameWords = [];
	let filteredWords = [];
	let gameScore = 0;
	let timeLeft = 60;
	let gameInterval;
	let selectedDuration = 60; // Default time

	// 1. SET TIME (Called by buttons t60, t90, t120)
	window.setTime = function(seconds) {
		selectedDuration = seconds;
		// UI Feedback: Reset colors and highlight active
		document.querySelectorAll('.time-opt').forEach(btn => btn.style.background = '#64748b');
		const activeBtn = document.getElementById('t' + seconds);
		if(activeBtn) activeBtn.style.background = '#db2777';
	};

	// 2. LOAD WORDS & POPULATE CATEGORIES
	async function loadWords() {
		const originalUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRzCZ1TCzstZPFtem7rrT6ZHZM4SXZdeI6r5SJTz32issZ5ZCLiNN9l2PE-MSqVErhyNN0EZxeVud3H/pub?gid=1360810286&single=true&output=csv';
		const csvUrl = 'https://corsproxy.io/?' + encodeURIComponent(originalUrl);

		try {
			const res = await fetch(csvUrl);
			const text = await res.text();
			const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
			
			gameWords = lines.slice(1).map(line => {
				const p = line.split(',');
				return { category: p[0]?.trim() || "General", word: p[1]?.trim() || "", translation: p[2]?.trim() || "" };
			}).filter(item => item.word !== "");

			// Build Checklist UI
			const container = document.getElementById('category-items');
			container.innerHTML = "";
			const categories = [...new Set(gameWords.map(item => item.category))].sort();
			
			categories.forEach(cat => {
				const label = document.createElement('label');
				label.style.display = "block";
				label.innerHTML = `<input type="checkbox" class="cat-check" value="${cat}" checked> ${cat}`;
				container.appendChild(label);
			});
		} catch (e) {
			console.error("Load failed", e);
		}
	}

	// 3. START GAME (Merged version)
	window.startBigTV = async function() {
		if (gameWords.length === 0) await loadWords();
		
		// Get all checked categories
		const selectedCats = Array.from(document.querySelectorAll('.cat-check:checked')).map(cb => cb.value);

		if (selectedCats.length === 0) return alert("Please select at least one category!");

		// Filter words
		filteredWords = gameWords.filter(w => selectedCats.includes(w.category));

		if (filteredWords.length === 0) return alert("No words found in these categories!");

		// UI Switch
		document.getElementById('game-lobby').classList.add('hidden');
		document.getElementById('game-active').classList.remove('hidden');
		
		gameScore = 0;
		timeLeft = selectedDuration;
		document.getElementById('score').innerText = gameScore;
		document.getElementById('timer').innerText = timeLeft;
		
		updateWord();

		if (gameInterval) clearInterval(gameInterval);
		gameInterval = setInterval(() => {
			timeLeft--;
			document.getElementById('timer').innerText = timeLeft;
			if (timeLeft <= 0) endGame();
		}, 1000);
	};

	// 4. UPDATE WORD (Randomly picks from filtered list)
	window.updateWord = function() {
		if (filteredWords.length > 0) {
			const item = filteredWords[Math.floor(Math.random() * filteredWords.length)];
			document.getElementById('word-display').innerHTML = `
				<div class="display-word">${item.word}</div>
				<div class="display-translation">${item.translation || ''}</div>
				<div class="display-category">${item.category || ''}</div>
			`;
		}
	};

	// 5. NEXT WORD (Handles score and effects)
	window.nextWord = function(isCorrect) {
		const display = document.getElementById('word-display');
		if (isCorrect) {
			gameScore++;
			document.getElementById('score').innerText = gameScore;
			display.classList.add('flash-green');
			setTimeout(() => display.classList.remove('flash-green'), 300);
		}
		updateWord();
	};

	// 6. END GAME
	window.endGame = function(manual = false) {
    clearInterval(gameInterval);
    if (manual) {
        if (!confirm("End game early?")) {
            // Restart timer if they cancel
            gameInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft;
                if (timeLeft <= 0) endGame();
            }, 1000);
            return;
        }
    }
    alert("GAME OVER! Final Score: " + gameScore);
    document.getElementById('game-lobby').classList.remove('hidden');
    document.getElementById('game-active').classList.add('hidden');
};
	// Add this at the very bottom of your script
	window.addEventListener('load', () => {
		loadWords();
	});
	
	window.toggleAllCats = function(checked) {
    // Select all checkboxes inside the category-items list
    const checkboxes = document.querySelectorAll('.cat-check');
    checkboxes.forEach(cb => {
        cb.checked = checked;
    });
};

</script>
</body>
</html>
